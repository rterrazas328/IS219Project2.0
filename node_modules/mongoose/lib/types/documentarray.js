<<<<<<< HEAD
=======

>>>>>>> 923637243c51b35e8862bfced9d2f31719759a83
/*!
 * Module dependencies.
 */

<<<<<<< HEAD
var MongooseArray = require('./array'),
    ObjectId = require('./objectid'),
    ObjectIdSchema = require('../schema/objectid'),
    utils = require('../utils'),
    Document = require('../document');
=======
var MongooseArray = require('./array')
  , driver = global.MONGOOSE_DRIVER_PATH || '../drivers/node-mongodb-native'
  , ObjectId = require(driver + '/objectid')
  , ObjectIdSchema = require('../schema/objectid')
  , utils = require('../utils')
  , util = require('util')
  , Document = require('../document')
>>>>>>> 923637243c51b35e8862bfced9d2f31719759a83

/**
 * DocumentArray constructor
 *
 * @param {Array} values
 * @param {String} path the path to this array
 * @param {Document} doc parent document
 * @api private
 * @return {MongooseDocumentArray}
 * @inherits MongooseArray
 * @see http://bit.ly/f6CnZU
 */

<<<<<<< HEAD
function MongooseDocumentArray(values, path, doc) {
  var arr = [].concat(values);

  // Values always have to be passed to the constructor to initialize, since
  // otherwise MongooseArray#push will mark the array as modified to the parent.
  utils.decorate( arr, MongooseDocumentArray.mixin );
  arr.isMongooseArray = true;
  arr.isMongooseDocumentArray = true;
=======
function MongooseDocumentArray (values, path, doc) {
  var arr = [];

  // Values always have to be passed to the constructor to initialize, since
  // otherwise MongooseArray#push will mark the array as modified to the parent.
  arr = arr.concat(values);
  arr.__proto__ = MongooseDocumentArray.prototype;
>>>>>>> 923637243c51b35e8862bfced9d2f31719759a83

  arr._atomics = {};
  arr.validators = [];
  arr._path = path;

<<<<<<< HEAD
  // Because doc comes from the context of another function, doc === global
  // can happen if there was a null somewhere up the chain (see #3020 && #3034)
  // RB Jun 17, 2015 updated to check for presence of expected paths instead
  // to make more proof against unusual node environments
  if (doc && doc instanceof Document) {
=======
  if (doc) {
>>>>>>> 923637243c51b35e8862bfced9d2f31719759a83
    arr._parent = doc;
    arr._schema = doc.schema.path(path);
    arr._handlers = {
      isNew: arr.notify('isNew'),
      save: arr.notify('save')
<<<<<<< HEAD
    };

=======
    }
>>>>>>> 923637243c51b35e8862bfced9d2f31719759a83
    doc.on('save', arr._handlers.save);
    doc.on('isNew', arr._handlers.isNew);
  }

  return arr;
<<<<<<< HEAD
}
=======
};
>>>>>>> 923637243c51b35e8862bfced9d2f31719759a83

/*!
 * Inherits from MongooseArray
 */
<<<<<<< HEAD
MongooseDocumentArray.mixin = Object.create( MongooseArray.mixin );
=======

MongooseDocumentArray.prototype.__proto__ = MongooseArray.prototype;
>>>>>>> 923637243c51b35e8862bfced9d2f31719759a83

/**
 * Overrides MongooseArray#cast
 *
<<<<<<< HEAD
 * @method _cast
 * @api private
 * @receiver MongooseDocumentArray
 */

MongooseDocumentArray.mixin._cast = function(value, index) {
=======
 * @api private
 */

MongooseDocumentArray.prototype._cast = function (value) {
>>>>>>> 923637243c51b35e8862bfced9d2f31719759a83
  if (value instanceof this._schema.casterConstructor) {
    if (!(value.__parent && value.__parentArray)) {
      // value may have been created using array.create()
      value.__parent = this._parent;
      value.__parentArray = this;
    }
<<<<<<< HEAD
    value.__index = index;
=======
>>>>>>> 923637243c51b35e8862bfced9d2f31719759a83
    return value;
  }

  // handle cast('string') or cast(ObjectId) etc.
  // only objects are permitted so we can safely assume that
  // non-objects are to be interpreted as _id
  if (Buffer.isBuffer(value) ||
      value instanceof ObjectId || !utils.isObject(value)) {
    value = { _id: value };
  }
<<<<<<< HEAD
  return new this._schema.casterConstructor(value, this, undefined, undefined, index);
=======

  return new this._schema.casterConstructor(value, this);
>>>>>>> 923637243c51b35e8862bfced9d2f31719759a83
};

/**
 * Searches array items for the first document with a matching _id.
 *
 * ####Example:
 *
 *     var embeddedDoc = m.array.id(some_id);
 *
<<<<<<< HEAD
 * @return {EmbeddedDocument|null} the subdocument or null if not found.
 * @param {ObjectId|String|Number|Buffer} id
 * @TODO cast to the _id based on schema for proper comparison
 * @method id
 * @api public
 * @receiver MongooseDocumentArray
 */

MongooseDocumentArray.mixin.id = function(id) {
  var casted,
      sid,
      _id;
=======
 * @return {EmbeddedDocument|null} the subdocuent or null if not found.
 * @param {ObjectId|String|Number|Buffer} id
 * @TODO cast to the _id based on schema for proper comparison
 * @api public
 */

MongooseDocumentArray.prototype.id = function (id) {
  var casted
    , sid
    , _id
>>>>>>> 923637243c51b35e8862bfced9d2f31719759a83

  try {
    var casted_ = ObjectIdSchema.prototype.cast.call({}, id);
    if (casted_) casted = String(casted_);
  } catch (e) {
    casted = null;
  }

  for (var i = 0, l = this.length; i < l; i++) {
    _id = this[i].get('_id');

<<<<<<< HEAD
    if (_id === null || typeof _id === 'undefined') {
      continue;
    } else if (_id instanceof Document) {
      sid || (sid = String(id));
      if (sid == _id._id) return this[i];
    } else if (!(_id instanceof ObjectId)) {
      if (utils.deepEqual(id, _id)) return this[i];
=======
    if (_id instanceof Document) {
      sid || (sid = String(id));
      if (sid == _id._id) return this[i];
    } else if (!(_id instanceof ObjectId)) {
      sid || (sid = String(id));
      if (sid == _id) return this[i];
>>>>>>> 923637243c51b35e8862bfced9d2f31719759a83
    } else if (casted == _id) {
      return this[i];
    }
  }

  return null;
};

/**
 * Returns a native js Array of plain js objects
 *
 * ####NOTE:
 *
 * _Each sub-document is converted to a plain object by calling its `#toObject` method._
 *
 * @param {Object} [options] optional options to pass to each documents `toObject` method call during conversion
 * @return {Array}
<<<<<<< HEAD
 * @method toObject
 * @api public
 * @receiver MongooseDocumentArray
 */

MongooseDocumentArray.mixin.toObject = function(options) {
  return this.map(function(doc) {
=======
 * @api public
 */

MongooseDocumentArray.prototype.toObject = function (options) {
  return this.map(function (doc) {
>>>>>>> 923637243c51b35e8862bfced9d2f31719759a83
    return doc && doc.toObject(options) || null;
  });
};

/**
 * Helper for console.log
 *
<<<<<<< HEAD
 * @method inspect
 * @api public
 * @receiver MongooseDocumentArray
 */

MongooseDocumentArray.mixin.inspect = function() {
  return Array.prototype.slice.call(this);
=======
 * @api public
 */

MongooseDocumentArray.prototype.inspect = function () {
  return '[' + this.map(function (doc) {
    if (doc) {
      return doc.inspect
        ? doc.inspect()
        : util.inspect(doc)
    }
    return 'null'
  }).join('\n') + ']';
>>>>>>> 923637243c51b35e8862bfced9d2f31719759a83
};

/**
 * Creates a subdocument casted to this schema.
 *
 * This is the same subdocument constructor used for casting.
 *
 * @param {Object} obj the value to cast to this arrays SubDocument schema
<<<<<<< HEAD
 * @method create
 * @api public
 * @receiver MongooseDocumentArray
 */

MongooseDocumentArray.mixin.create = function(obj) {
  return new this._schema.casterConstructor(obj);
};
=======
 * @api public
 */

MongooseDocumentArray.prototype.create = function (obj) {
  return new this._schema.casterConstructor(obj);
}
>>>>>>> 923637243c51b35e8862bfced9d2f31719759a83

/**
 * Creates a fn that notifies all child docs of `event`.
 *
 * @param {String} event
 * @return {Function}
<<<<<<< HEAD
 * @method notify
 * @api private
 * @receiver MongooseDocumentArray
 */

MongooseDocumentArray.mixin.notify = function notify(event) {
  var self = this;
  return function notify(val) {
    var i = self.length;
    while (i--) {
      if (!self[i]) continue;
      switch (event) {
=======
 * @api private
 */

MongooseDocumentArray.prototype.notify = function notify (event) {
  var self = this;
  return function notify (val) {
    var i = self.length;
    while (i--) {
      if (!self[i]) continue;
      switch(event) {
>>>>>>> 923637243c51b35e8862bfced9d2f31719759a83
        // only swap for save event for now, we may change this to all event types later
        case 'save':
          val = self[i];
          break;
        default:
          // NO-OP
          break;
      }
      self[i].emit(event, val);
    }
<<<<<<< HEAD
  };
};
=======
  }
}
>>>>>>> 923637243c51b35e8862bfced9d2f31719759a83

/*!
 * Module exports.
 */

module.exports = MongooseDocumentArray;
