
<<<<<<< HEAD
var fs = require('fs');
var jade = require('jade');
var package = require('./package');
var hl = require('./docs/helpers/highlight');
var linktype = require('./docs/helpers/linktype');
var href = require('./docs/helpers/href');
var klass = require('./docs/helpers/klass');
=======
var fs= require('fs')
var jade = require('jade')
var package = require('./package')
var hl = require('./docs/helpers/highlight')
var linktype = require('./docs/helpers/linktype')
var href = require('./docs/helpers/href')
var klass = require('./docs/helpers/klass')
>>>>>>> 923637243c51b35e8862bfced9d2f31719759a83

// add custom jade filters
require('./docs/helpers/filters')(jade);

// use last release
package.version = getVersion();
package.unstable = getUnstable(package.version);

var filemap = require('./docs/source');
var files = Object.keys(filemap);

<<<<<<< HEAD
files.forEach(function(file) {
=======
files.forEach(function (file) {
>>>>>>> 923637243c51b35e8862bfced9d2f31719759a83
  var filename = __dirname + '/' + file;
  jadeify(filename, filemap[file]);

  if ('--watch' == process.argv[2]) {
<<<<<<< HEAD
    fs.watchFile(filename, { interval: 1000 }, function(cur, prev) {
=======
    fs.watchFile(filename, { interval: 1000 }, function (cur, prev) {
>>>>>>> 923637243c51b35e8862bfced9d2f31719759a83
      if (cur.mtime > prev.mtime) {
        jadeify(filename, filemap[file]);
      }
    });
  }
});

<<<<<<< HEAD
var acquit = require('./docs/source/acquit');
var acquitFiles = Object.keys(acquit);
acquitFiles.forEach(function(file) {
  var filename = __dirname + '/docs/acquit.jade';
  jadeify(filename, acquit[file], __dirname + '/docs/' + file);
});

function jadeify(filename, options, newfile) {
=======
function jadeify (filename, options) {
>>>>>>> 923637243c51b35e8862bfced9d2f31719759a83
  options || (options = {});
  options.package = package;
  options.hl = hl;
  options.linktype = linktype;
  options.href = href;
  options.klass = klass;
<<<<<<< HEAD
  jade.renderFile(filename, options, function(err, str) {
    if (err) return console.error(err.stack);

    newfile = newfile || filename.replace('.jade', '.html');
    fs.writeFile(newfile, str, function(err) {
=======
  jade.renderFile(filename, options, function (err, str) {
    if (err) return console.error(err.stack);

    var newfile = filename.replace('.jade', '.html')
    fs.writeFile(newfile, str, function (err) {
>>>>>>> 923637243c51b35e8862bfced9d2f31719759a83
      if (err) return console.error('could not write', err.stack);
      console.log('%s : rendered ', new Date, newfile);
    });
  });
}

<<<<<<< HEAD
function getVersion() {
=======
function getVersion () {
>>>>>>> 923637243c51b35e8862bfced9d2f31719759a83
  var hist = fs.readFileSync('./History.md','utf8').replace(/\r/g, '\n').split('\n');
  for (var i = 0; i < hist.length; ++i) {
    var line = (hist[i] || '').trim();
    if (!line) continue;
    var match = /^\s*([^\s]+)\s/.exec(line);
    if (match && match[1])
      return match[1];
  }
  throw new Error('no match found');
}

function getUnstable(ver) {
  ver = ver.replace("-pre");
  var spl = ver.split('.');
<<<<<<< HEAD
  spl = spl.map(function(i) {
=======
  spl = spl.map(function (i) {
>>>>>>> 923637243c51b35e8862bfced9d2f31719759a83
    return parseInt(i);
  });
  spl[1]++;
  spl[2] = "x";
  return spl.join('.');
}
